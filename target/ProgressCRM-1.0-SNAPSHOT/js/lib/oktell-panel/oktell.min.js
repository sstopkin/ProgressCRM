Oktell=function(){var a=!1,b="",c=function(){if(a){var c=new Date,d=c.getFullYear()+"-"+(c.getMonth()<10?"0":"")+c.getMonth()+"-"+(c.getDate()<10?"0":"")+c.getDate(),e=(c.getHours()<10?"0":"")+c.getHours()+":"+(c.getMinutes()<10?"0":"")+c.getMinutes()+":"+(c.getSeconds()<10?"0":"")+c.getSeconds()+":"+(c.getMilliseconds()+1e3).toString().substr(1);b+=d+" "+e+" | ",args=["Oktell.js "+e+" |"];for(var f=0,g=arguments.length;g>f;f++)b+=("object"==typeof arguments[f]?JSON.stringify(arguments[f]):arguments[f])+" | ",args.push(arguments[f]);b+="\n\n";try{console.log.apply(console,args||[])}catch(h){a=!1}}},d=function(a){var b,c,d,e,f,g,h,i,j,k,l=function(a,b){return a<<b|a>>>32-b},m=function(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f},n=function(a,b,c){return a&b|~a&c},o=function(a,b,c){return a&c|b&~c},p=function(a,b,c){return a^b^c},q=function(a,b,c){return b^(a|~c)},r=function(a,b,c,d,e,f,g){return a=m(a,m(m(n(b,c,d),e),g)),m(l(a,f),b)},s=function(a,b,c,d,e,f,g){return a=m(a,m(m(o(b,c,d),e),g)),m(l(a,f),b)},t=function(a,b,c,d,e,f,g){return a=m(a,m(m(p(b,c,d),e),g)),m(l(a,f),b)},u=function(a,b,c,d,e,f,g){return a=m(a,m(m(q(b,c,d),e),g)),m(l(a,f),b)},v=function(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=new Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g},w=function(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d},x=[],y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(x=v(a),h=1732584193,i=4023233417,j=2562383102,k=271733878,b=x.length,c=0;b>c;c+=16)d=h,e=i,f=j,g=k,h=r(h,i,j,k,x[c+0],y,3614090360),k=r(k,h,i,j,x[c+1],z,3905402710),j=r(j,k,h,i,x[c+2],A,606105819),i=r(i,j,k,h,x[c+3],B,3250441966),h=r(h,i,j,k,x[c+4],y,4118548399),k=r(k,h,i,j,x[c+5],z,1200080426),j=r(j,k,h,i,x[c+6],A,2821735955),i=r(i,j,k,h,x[c+7],B,4249261313),h=r(h,i,j,k,x[c+8],y,1770035416),k=r(k,h,i,j,x[c+9],z,2336552879),j=r(j,k,h,i,x[c+10],A,4294925233),i=r(i,j,k,h,x[c+11],B,2304563134),h=r(h,i,j,k,x[c+12],y,1804603682),k=r(k,h,i,j,x[c+13],z,4254626195),j=r(j,k,h,i,x[c+14],A,2792965006),i=r(i,j,k,h,x[c+15],B,1236535329),h=s(h,i,j,k,x[c+1],C,4129170786),k=s(k,h,i,j,x[c+6],D,3225465664),j=s(j,k,h,i,x[c+11],E,643717713),i=s(i,j,k,h,x[c+0],F,3921069994),h=s(h,i,j,k,x[c+5],C,3593408605),k=s(k,h,i,j,x[c+10],D,38016083),j=s(j,k,h,i,x[c+15],E,3634488961),i=s(i,j,k,h,x[c+4],F,3889429448),h=s(h,i,j,k,x[c+9],C,568446438),k=s(k,h,i,j,x[c+14],D,3275163606),j=s(j,k,h,i,x[c+3],E,4107603335),i=s(i,j,k,h,x[c+8],F,1163531501),h=s(h,i,j,k,x[c+13],C,2850285829),k=s(k,h,i,j,x[c+2],D,4243563512),j=s(j,k,h,i,x[c+7],E,1735328473),i=s(i,j,k,h,x[c+12],F,2368359562),h=t(h,i,j,k,x[c+5],G,4294588738),k=t(k,h,i,j,x[c+8],H,2272392833),j=t(j,k,h,i,x[c+11],I,1839030562),i=t(i,j,k,h,x[c+14],J,4259657740),h=t(h,i,j,k,x[c+1],G,2763975236),k=t(k,h,i,j,x[c+4],H,1272893353),j=t(j,k,h,i,x[c+7],I,4139469664),i=t(i,j,k,h,x[c+10],J,3200236656),h=t(h,i,j,k,x[c+13],G,681279174),k=t(k,h,i,j,x[c+0],H,3936430074),j=t(j,k,h,i,x[c+3],I,3572445317),i=t(i,j,k,h,x[c+6],J,76029189),h=t(h,i,j,k,x[c+9],G,3654602809),k=t(k,h,i,j,x[c+12],H,3873151461),j=t(j,k,h,i,x[c+15],I,530742520),i=t(i,j,k,h,x[c+2],J,3299628645),h=u(h,i,j,k,x[c+0],K,4096336452),k=u(k,h,i,j,x[c+7],L,1126891415),j=u(j,k,h,i,x[c+14],M,2878612391),i=u(i,j,k,h,x[c+5],N,4237533241),h=u(h,i,j,k,x[c+12],K,1700485571),k=u(k,h,i,j,x[c+3],L,2399980690),j=u(j,k,h,i,x[c+10],M,4293915773),i=u(i,j,k,h,x[c+1],N,2240044497),h=u(h,i,j,k,x[c+8],K,1873313359),k=u(k,h,i,j,x[c+15],L,4264355552),j=u(j,k,h,i,x[c+6],M,2734768916),i=u(i,j,k,h,x[c+13],N,1309151649),h=u(h,i,j,k,x[c+4],K,4149444226),k=u(k,h,i,j,x[c+11],L,3174756917),j=u(j,k,h,i,x[c+2],M,718787259),i=u(i,j,k,h,x[c+9],N,3951481745),h=m(h,d),i=m(i,e),j=m(j,f),k=m(k,g);var O=w(h)+w(i)+w(j)+w(k);return O.toLowerCase()},e=function(a){var b=[],c=0,d=0,e=0,f=0,g=0;for(a+="";c<a.length;)e=a.charCodeAt(c),128>e?(b[d++]=String.fromCharCode(e),c++):e>191&&224>e?(f=a.charCodeAt(c+1),b[d++]=String.fromCharCode((31&e)<<6|63&f),c+=2):(f=a.charCodeAt(c+1),g=a.charCodeAt(c+2),b[d++]=String.fromCharCode((15&e)<<12|(63&f)<<6|63&g),c+=3);return b.join("")},f=function(a){for(var b="",c=0,d=0;d<a.length;d++)c=a.charCodeAt(d),c>127?c>1024&&(1025==c?c=1016:1105==c&&(c=1032),b+=String.fromCharCode(c-848)):b+=a.charAt(d);return b},g=function(a){var b,c,d,f,g,h,i,j,k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,m=0,n="",o=[];if(!a)return a;a+="";do f=k.indexOf(a.charAt(l++)),g=k.indexOf(a.charAt(l++)),h=k.indexOf(a.charAt(l++)),i=k.indexOf(a.charAt(l++)),j=f<<18|g<<12|h<<6|i,b=j>>16&255,c=j>>8&255,d=255&j,o[m++]=64==h?String.fromCharCode(b):64==i?String.fromCharCode(b,c):String.fromCharCode(b,c,d);while(l<a.length);return n=o.join(""),n=e(n)},h=function(a){var b=Array.prototype.slice.call(arguments,1);return m(b,function(b){m(b,function(c,d){b.hasOwnProperty(d)&&(a[d]=c)})}),a},i=function(a){return Array.isArray?Array.isArray(a):"[object Array]"==Object.prototype.toString.call(a)},j=function(a,b){if(b)return JSON.parse(JSON.stringify(a));var c={};for(var d in a)a.hasOwnProperty(d)&&(c[d]="object"==typeof a[d]?j(a[d],!1):a[d]);return c},k=function(a){if(a=a||[],i(a))return a.length;if(a===Object(a)){if(Object.keys)return Object.keys(a).length;var b=0;for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b++;return b}return!1},l={},m=function(a,b,c){if(null!=a)if(Array.prototype.forEach&&a.forEach===Array.prototype.forEach)a.forEach(b,c);else if(a.length===+a.length){for(var d=0,e=a.length;e>d;d++)if(d in a&&b.call(c,a[d],d,a)===l)return}else for(var f in a)if(Object.prototype.hasOwnProperty.call(a,f)&&b.call(c,a[f],f,a)===l)return},n=function(a){return a.replace(/^\s+/,"").replace(/\s+$/,"")},o=function(a){if(!a)return"";a=a.toString().split(";").join(",");for(var b=a.split(","),c=0;c<b.length;c++){b[c]=n(b[c]);var d,e="",f="",g="";if(""!=b[c]){if(-1!=b[c].indexOf("(")){var h=b[c].split("(");e=n(h[0]),h=h[1].split(")"),f=n(h[0]);var d=n(h[1]);d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),-1==d.indexOf("-")&&(h=[d.split(" ")[0],d.split(" ").slice(1).join(" ")],d=n(h[0]),g=n(h[1]),5==d.length&&(d=d.substr(0,3)+"-"+d.substr(3,2)),6==d.length&&(d=d.substr(0,2)+"-"+d.substr(2,2)+"-"+d.substr(4,2)),7==d.length&&(d=d.substr(0,3)+"-"+d.substr(3,2)+"-"+d.substr(5,2)),""!=g&&(d+=" "+g))}else{d=b[c].split("+").join(""),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2"),d=d.replace(/(.?[0-9]) ([0-9].?)/gi,"$1-$2");var h=[d.split(" ")[0],d.split(" ").slice(1).join(" ")];d=n(h[0]),d=d.split("-").join(""),d=d.split("—").join(""),g=n(h[1]),5==d.length?d=d.substr(0,3)+"-"+d.substr(3,2):6==d.length?d=d.substr(0,2)+"-"+d.substr(2,2)+"-"+d.substr(4,2):7==d.length?d=d.substr(0,3)+"-"+d.substr(3,2)+"-"+d.substr(5,2):9==d.length?(f=d.substr(0,3),d=d.substr(3,2)+"-"+d.substr(5,2)+"-"+d.substr(7,2)):10==d.length?(f=d.substr(0,3),d=d.substr(3,3)+"-"+d.substr(6,2)+"-"+d.substr(8,2)):11==d.length?(e=d.substr(0,1),f=d.substr(1,3),d=d.substr(4,3)+"-"+d.substr(7,2)+"-"+d.substr(9,2)):12==d.length?(e=d.substr(0,2),f=d.substr(2,3),d=d.substr(5,3)+"-"+d.substr(8,2)+"-"+d.substr(10,2)):13==d.length?(e=d.substr(0,3),f=d.substr(3,3),d=d.substr(6,3)+"-"+d.substr(9,2)+"-"+d.substr(11,2)):14==d.length&&(e=d.substr(0,4),f=d.substr(4,3),d=d.substr(7,3)+"-"+d.substr(10,2)+"-"+d.substr(12,2)),""!=g&&(d+=" "+g)}"8"==e&&(e="+7"),"+"!=e[0]&&""!=e&&(e="+"+e);var i=[];""!=e&&i.push(e),""!=f&&i.push("("+f+")"),""!=d&&i.push(d),b[c]=i.join(" ")}}return a=b.join(", ")},p=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},q=function(a){if("object"==typeof a){var b="";return m(a,function(a,c){b+="&"+c+"="+a.toString()}),b}return!1},r=function(a){return"string"==typeof a&&a.match(/[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}/)||32==a.length&&a.match(/[a-zA-Z0-9]{32}/)?!0:!1},s=function(a){"function"==typeof a&&a.apply(void 0,Array.prototype.slice.call(arguments,1))},t=function(a,b,c){if(arguments.length>1&&"[object Object]"!==String(b)){if(c=h({},c),(null===b||void 0===b)&&(c.expires=-1),"number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setSeconds(e.getSeconds()+d)}return b=String(b),document.cookie=[encodeURIComponent(a),"=",c.raw?b:encodeURIComponent(b),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?g(f[1]):null},u=/\s+/,v=function(a){if("string"==typeof a)a=a.replace(/,/g," ").split(u);else{if(!(i(a)&&a.length>0))return!1;for(var b=[],c=0;c<a.length;c++){var d=a[c];d&&"string"==typeof d&&b.push(d)}eventsNames=b}return a},w={on:function(a,b,c){if(a=v(a),!a||"function"!=typeof b)return!1;var d=this._callbacks||(this._callbacks={});return m(a,function(a){if("string"!=typeof a)return l;var e=d[a]||(d[a]=[]);e.push({callback:b,context:c})}),!0},off:function(a,b){var c=this._callbacks||(this._callbacks={});if(a){if(a=v(a),!a)return!1;"function"==typeof b?m(a,function(a){"string"==typeof a&&m(c[a],function(d,e){d&&d.callback===b&&delete c[a][e]})}):m(a,function(a){delete c[a]})}else c={};return!0},trigger:function(a){a=v(a);var b=this._callbacks||(this._callbacks={});if(!a)return!1;var c=Array.prototype.slice.call(arguments,1),d=b.all;return m(a,function(a){var e=b[a];if(e&&m(e,function(a){a&&"function"==typeof a.callback&&a.callback.apply(a.context||void 0,c)}),d){var f=[a].concat(c);m(d,function(a){a&&"function"==typeof a.callback&&a.callback.apply(a.context||void 0,f)})}}),!0}},x=function(a,b,d,e,f){var j,k={},n=/^ws[s]{0,1}:\/\/\S+$/i,o=this,p=!1,q=!1,r={},t={},u={},w={},x={dynamic:["executemethod","cancelmethod"],dynamicwaitabort:["executemethodwaitaborted"],chat:["chatmessageviewed","chatmessage","chatmemberremoved","chatmemberadded","chatnamechanged","chatcreated"],dlgcard:["dlgcard_showreserve","dlgcard_showconfirm","dlgcard_showformstop","dlgcard_showformdialog","dlgcard_closeall","dlgcard_closereserve","dlgcard_closeformreturnvalues","dlgcard_closeformreturncomment"]};o.setQueryDelayMin(d),o.setQueryDelayMax(e);var y=function(a){if(!i(a))return!1;for(var b,c="https:"==location.protocol?!0:!1,d=80,e=[],f=a.length;f>b;b++){if("string"!=typeof a[b])return!1;if(n.text(a[b]))e.push(a[b]);else{var g=a[b].split(":"),h=g[0],j=g[1];j||(j=d,e.push(h+":4066")),"443"==j&&(c=!0),e.push(h+":"+j)}}for(var b,k=c?"wss://":"ws//",f=e.length;f>b;b++)n.text(a[b])||(e[b]=k+e[b])},z=function(){},A=function(){},A=function(){},B=!1,C=function(a){if(B)a.close();else{B=!0,j=a;var b=Math.random().toString();j.onmessage=function(c){var d=JSON.parse(c.data),e=function(a){o.ws=a,a.onmessage=F,a.onclose=z,a.onerror=A,E()};if("websocketredirect"==d[0]){var f=new WebSocket(a.url.replace("ws://","wss://").replace(":4066",":443"),"json");f.onopen=function(){e(f)}}else d[1]&&d[1].qid==b&&e(a)},j.send(JSON.stringify(["ping",{qid:b}]))}};o.n_connect=function(){for(var b,c=y(a),d=c.length;d>b;b++)setTimeout(function(){var a=new WebSocket(c[b],"json");a.onopen=function(){C(a)},a.onerror=function(){},a.onclose=function(){}},1)},o.url=a;var D=function(){q||(q=!0,o.trigger("errorConnection"))},E=function(){p=!0,"function"==typeof f&&(c("success connect to "+j.url),f(j.url))},F=function(a){var b=JSON.parse(a.data);H(b);var c=!1;if("multipart"==b[0]){var d=t[b[1]["message-id"]];if(d||(d={packetcount:b[1].packetcount,content:[],value:""},t[b[1]["message-id"]]=d),d.content[parseInt(b[1].packetnumber)]=b[1].content.toString(),d.content.length==d.packetcount){for(var e=0;e<d.content.length;e++)d.value=""+d.value+g(d.content[e]);c=!0}}if(("multipart"!=b[0]||"multipart"==b[0]&&c)&&(c&&(b=JSON.parse(t[b[1]["message-id"]].value)),"function"==typeof r[b[1].qid])){var f=r[b[1].qid];delete r[b[1].qid];var h=b[1];void 0===h.result&&(h.result=1),f(b[1])}},G=function(){p?q||o.trigger("connectionClose"):D(),w={}};o.multiConnect=function(){i(a)||(a=[a]),c("Multi connect start",a);var d=0;a=a.slice(0,10),m(a,function(e){setTimeout(function(){try{k[e]=new WebSocket(e,"json"),c("trying to connect "+e),k[e].onopen=function(){k[e].wasOpened=!0;var a=Math.random().toString();k[e].send(JSON.stringify(["ping",{qid:a}])),k[e].onmessage=function(b){if(p)return!1;var d=JSON.parse(b.data),f=function(){o.url=e,o.wsUrl=j=k[e],j.onmessage=F,j.onclose=G,E()};if("websocketredirect"==d[0]){var g=e.replace(/^ws:\/\//,"wss://").replace(/:[0-9]{1,5}/,":443");c("redirect to secure websocket, trying to connect "+g),k[e].close(),e=g;var h=new WebSocket(e,"json");h.onopen=function(){return p?!1:void f()},k[e]=h}else d[1]&&d[1].qid==a&&f()}},setTimeout(function(){(1!=o.getWebSocketState(k[e])&&!k[e].wasOpened||o.url!=e)&&(o.disconnect(k[e]),d++,d==a.length&&(d=-999,D()))},b)}catch(f){return d++,d==a.length&&(d=-999,o.trigger("errorConnection",f)),l}},1)})},o.connect=function(){q=!1;try{c("trying to connect "+a),j=new WebSocket("ws://"+a,"json"),setTimeout(function(){0==o.getWebSocketState()&&(o.disconnect(),D())},b)}catch(d){return o.trigger("errorConnection",d),!1}j.onopen=E,j.onmessage=F,j.onclose=G},o.send=function(a,b,c){JSON.parse(a);if("function"==typeof c&&(r[b]=c),o.delayMin>0){var d=o.delayMin;return e&&(d=Math.round(Math.random()*Math.abs(o.delayMax-o.delayMin)+o.delayMin)),setTimeout(function(){j.send(a)},d),!0}return j.send(a)},o.sendOktell=function(a,b,c){b=b||{};var d=new Array;d.push(a),b.qid=Math.random().toString(),d.push(b),o.send(JSON.stringify(d),d[1].qid,c)===!1&&s(c,{result:0,errormsg:"websocket send error"})},o.execProc=function(a,b,c){var d=["execpredefineddbstoredproc",h({qid:Math.random().toString(),procedure:a},b)];o.send(JSON.stringify(d),d[1].qid,function(a){var b=[];if(1==a.result&&0==a.errorcode)for(var d=0;d<a.dataset.length;d++){var e=[];b.push(e);for(var f=[],g=0;g<a.dataset[d][0].length;g++)f.push(a.dataset[d][0][g]);for(var h=1;h<a.dataset[d].length;h++){for(var i={},j=0;j<f.length;j++)i[f[j]]=a.dataset[d][h][j];e.push(i)}}else b=!1;s(c,b,a.dataset)})},o.bindOktellEvent=function(a,b){return a=v(a),a&&"function"==typeof b?(m(a,function(a){u[a]||(u[a]=[]),u[a].push(b)}),o.sendOktellEventSubscription(a),!0):!1};var H=function(a){u&&u[a[0]]&&(c("<<< EVENT "+a[0],a[1]),m(u[a[0]],function(b){s(b,a[1])}))};o.sendOktellEventSubscription=function(a,b){var d=this;if(a=v(a),!a)return!1;var e=[];m(a,function(a){w[a]||(e.push(a),i(x[a])&&d.sendOktellEventSubscription(x[a],!0)),b&&(w[a]=!0)}),!b&&e.length&&(c("===> Event subscription",e),d.sendOktell("subscribeevent",{eventmethod:e},function(a){c("<=== Event subscribtion result: "+a.result,e),m(e,function(a){w[a]=!0})}))},o.unbindOktellEvent=function(a,b){if(a){if(a=v(a),!a)return!1;b="function"==typeof b?b:!1;for(var c=0;c<a.length;c++){var d=a[c];b?m(u[d],function(a,c){a===b&&delete u[d][c]}):delete u[d]}}else u={};return!0},o.reSendOktellEventSubscribtions=function(){var a=[];m(w,function(b,c){b&&a.push(c)}),a.length&&o.sendOktell("subscribeevent",{eventmethod:a},function(){})},o.disconnect=function(a){a=a||j,a.close();var b=o.getWebSocketState(a);return 3==b||2==b?!0:!1},o.getWebSocketState=function(a){return a=a||j,a?a.readyState:void 0}};x.prototype.setQueryDelayMin=function(a){a=parseInt(a),a&&(this.delayMin=a)},x.prototype.setQueryDelayMax=function(a){a=parseInt(a),a&&(this.delayMax=a)},h(x.prototype,w);var y=function(){},z=function(){var e,g,n,u,z,A=this,B=!1,C=[],D={openTimeout:1e4,queryTimeout:2e4,queueInterval:5e3,oktellVoice:!1},E=!1,F={redirectNumber:void 0,allowedProcedures:{}},G={getmyuserinfo:{v:120327,critical:!0},getversion:{v:120112,critical:!0},pbxmakeflash:{v:120725},getextendedlineinfo:{v:120112,critical:!0},getflashedabonentinfo:{v:120112,critical:!0},saveredirectrules:{v:120725},deleteredirectrules:{v:120725},getredirectrules:{v:120725},pbxmaketransfer:{v:120725},triggercustomevent:{v:120725},getallusernumbers:{v:120920},cc_getlunchtypes:{v:130101},pbxanswercall:{v:131218}},H={},I="___oktellsessionid",J={},K={},L={},M=!1,N=function(a,b,c){A[a]||"function"!=typeof b||(A[a]=function(){return b.apply(c||A,arguments)})},O=function(a){return void 0!==a&&(B=a?!0:!1),B},P=h({},w),Q=function(){return e&&1==e.getWebSocketState()?!0:!1},R=function(a,b){if(void 0===a||!k(b))return!1;a=parseInt(a);var c="";return m(b,function(b,d){b==a&&(c=d.toLowerCase())}),c},S=function(a){if(!a||"string"!=typeof a&&"number"!=typeof a&&!i(a))return!1;("string"==typeof a||"number"==typeof a)&&(a=[a.toString()]);var b=!0;return m(a,function(a){return"string"!=typeof a?(b=!1,l):void 0}),b?a:!1},T=function(a){return F.oktellDated&&G[a]&&F.oktellDated<G[a].v?!1:!0},U={10:"critical ws method not supported by this version of Oktell server",11:"error loading version info",12:"websocket connection closed",13:"disconnected by user",14:"can't login using oktell.connect"},V=function(a,b){return{code:a,message:U[a]+" "+(b||"")||""}},W={1e3:"something goes wrong",1101:"method not supported by current Oktell version",1102:"server didnt understand method or response timeout",1103:"error execute method",1104:"bad method for execute",1105:"error execute stored procedure",1106:"bad params",1200:"cant connect to server",1201:"error websocket connection",1202:"error loginpass",1203:"oktell version too old",1204:"using oktell desktop client",1205:"error url",1206:"error loading version info",1207:"error loading phone state",1209:"error loading user state",1210:"error loading user info",1211:"login failure",1212:"error connect using session",1213:"no password or session",1214:"max online users count reached, license limitation",1215:"oktell service is not available",2001:"user state - disconnected",2002:"phone not connected",2101:"user has hold call and is talking now",2102:"user in conference now",2103:"phone state not valid for call",2104:"user state - busy",2105:"calling number is talking with us",2106:"bad number",2107:"error autocall method call",2108:"error user or phone state for call",2201:"no numbers to invite",2202:"cant build conference from current call",2203:"no number to create conference",2204:"error conference method call",2205:"bad user or phone state for creating conference",2206:"cant invite hold abonent",2207:"error inviting",2208:"cant create conference while in callcenter in break",2301:"error transfer method call",2302:"bad user or phone state for transfer",2303:"nothing to transfer",2304:"bad number for transfer",2401:"error toggle method executing",2402:"nothing to toggle, no hold",2501:"not in conference",2502:"server retunred error while enabling ghost mode",2503:"bad ghost mode",2504:"bad userId or number",2505:"error rigths",2506:"user is not in ghost mode",2507:"cant change ghost mode of this user",2601:"bad flash mode",2602:"error while exec flash method",2701:"error while loading user queue",2801:"wrong old password",2802:"incorrect new password",2803:"error while exec changepassword method on server",2901:"incorrect state",2902:"phone probably does not support intercom calls",3001:"error while getting temp pass",3002:"aborted in beforeRequest callback function"},X=function(a,b,d){a=parseInt(a);var e=h(d||{},{result:!1,errorCode:a,errorMessage:(W[a]?W[a]:"")+(b?b.toString():"")});return c("ERROR "+a+" "+e.errorMessage,e),e},Y=function(a){var b=h(a||{},{result:!0});return c("SUCCESS ",b),b},Z=function(a,b,c,d){return a?Y(b):X(c,d,b)},$=function(a,b){a=v(a),evObjs=[];for(var c=0;c<a.length;c++){for(var d=a[c],f=!1,g=0;g<C.length;g++){var h=C[g];if(h&&h.eventName==d&&h.callback===b){f=!0;break}}if(f)a[c]=void 0;else{var i={eventName:d,callback:b};C.push(i),evObjs.push(i)}}if(O()){for(var c=0;c<evObjs.length;c++)evObjs[c].binded=!0;e.bindOktellEvent(a,b)}},_=function(a,b){if(a){if(a=v(a),!a)return!1;b="function"==typeof b?b:!1;for(var c=0;c<a.length;c++)for(var d=a[c],f=0;f<C.length;f++){var g=C[f];g&&g.eventName==d&&(b&&g.callback===b||!b)&&(C[f]=void 0)}}else C=[];e&&e.unbindOktellEvent(a,b)},bb=function(a,b,d){var f="function"==typeof b?b:d;if(Q())if(T(a)){b=k(b)?b:{};var g,b=h({userlogin:F.login},b);if("function"==typeof f)var g=setTimeout(function(){c("error timer for method "+a),s(f,X(1102,": "+a))},D.queryTimeout);e.sendOktell(a,b,function(b){clearTimeout(g),c("<<<< "+a,b),s(f,b)}),c(">>>> "+a,b)}else s(f,X(1101," "+a)),G[a].critical&&wb(V(10),a);else s(f,X(1201))},cb=function(a,b,d){var f="function"==typeof b?b:d;if(a)if(F.allowedProcedures[a.toLowerCase()]){var g={userid:F.userid,userlogin:F.login,inputparams:b||{}};c(">>>> "+a,g),e.execProc(a,g,function(b,d){var e={result:!1};b&&(e.result=!0,e.datasets=b,e.datasetsRaw=d),c("<<<< "+a,e),s(f,Z(e.result,e,1105," "+a))})}else f?bb(a,b,function(b){var c=b.errorCode?Z(b.result,b,b.errorCode):Z(b.result,b,1103," "+a);s(f,c)}):bb(a,b);else s(f,X(1104))};N("exec",cb);var db=h({sendCustomBinding:function(){if(this._subscribed)return!1;this._subscribed=!0;var a=this;e.bindOktellEvent("customevent",function(b){b&&b.eventname&&a.trigger(b.eventname,b.eventparam)})},triggerCustomEvent:function(a,b,c,d){bb("triggercustomevent",{userid:F.userid,userlogin:F.login,eventname:a,eventparam:c,recipients:b,sendback:d?1:"0"})}},w);N("triggerCustomEvent",db.triggerCustomEvent,db),N("offCustomEvent",db.off,db),N("onCustomEvent",db.on,db);var eb=function(a){bb("getallusernumbers",{fillsubordinates:!0},function(b){b.result&&b.users?(m(b.users,function(a){J[a.id]={id:a.id,name:a.name,number:a.main||void 0,numbers:a.nums||[],controlledByMe:a.sub?!0:!1},J[a.id].numberObj=K[J[a.id].number]||void 0,J[a.id].numberObj&&(J[a.id].numberObj.userid=a.id,J[a.id].numberObj.userObj=J[a.id])}),bb("getalluserphotolink",{mode:"page"},function(b){if(b.result){var c=hb();m(b.links,function(a){var b=a.id==F.userid?F:J[a.id];b&&(b.avatarLink=a.link?c+a.link32x32:D.defaultAvatar||"",b.avatarLink32x32=a.link32x32?c+a.link32x32:D.defaultAvatar32x32||"",b.avatarLink96x96=a.link96x96?c+a.link96x96:D.defaultAvatar64x64||"")})}s(a)})):s(a)})},fb=function(a){return a?(a=a.toString())&&J[a]&&J[a].id?J[a].controlledByMe:K[a]&&K[a].userObj?K[a].userObj.controlledByMe:!1:!1},gb=function(a){bb("getpbxnumbers",{mode:"full"},function(b){b.result&&b.numbers&&m(b.numbers,function(a){K[a.number]=a,L[a.id]=K[a.number]}),s(a)})},hb=function(){if(F.currentUrl&&F.oktellWebServerPort){var a=F.currentUrl.match(/^wss/)?"https://":"http://",b=F.currentUrl.match(/wss?:\/\/([^\s\/:]+)/)[1];return port="",("https://"==a&&"443"!=A.getMyInfo().oktellWebServerPort||"http://"==a&&"80"!=A.getMyInfo().oktellWebServerPort)&&(port=":"+A.getMyInfo().oktellWebServerPort),a+b+port}return!1},ib=function(a,b){a&&(H[a]={time:(new Date).getTime(),callback:b})},jb=function(a,b){bb("gettemphttppass",{responsetowebsock:a?!0:!1},function(a){a.result?s(b,Y(a)):s(b,X(1103," gettemphttppass",a))})},kb=function(a,b){if(a){var c=a.toString().split(".");c.length<2||-1==["jpg","gif","png","jpeg"].indexOf(c[c.length-1])||bb("setmyuserphoto",{filepath:a},function(a){s(b,Z(a.result,{},1103," setmyuserphoto"))})}};N("setUserAvatar",kb);var lb=function(a){bb("getuserphoto",{mode:"page"},function(b){if(b.result){var c=hb();F.avatarLink=b.link?c+b.link32x32:D.defaultAvatar||"",F.avatarLink32x32=b.link32x32?c+b.link32x32:D.defaultAvatar32x32||"",F.avatarLink96x96=b.link96x96?c+b.link96x96:D.defaultAvatar64x64||"",s(a,Y({avatarLink:F.avatarLink,avatarLink32x32:F.avatarLink32x32,avatarLink96x96:F.avatarLink96x96}))}else s(a,X(1103," getuserphoto"))})};N("getUserAvatar",lb);var mb=function(a,b,c){var d=window.$||window.jQuery||void 0;if(!d)return nb.apply(A,arguments);var e=a.accept;delete a.accept,e?(i(e)||(e=[e]),e='accept="'+e.join(",")+'"'):e="";var f=Math.random().toString().replace(".",""),g="_oktelljs_user_avatar_frame_"+f,h="_oktelljs_user_avatar_form_"+f,j="_oktelljs_user_profile_select_file_"+f;d("body").append('<iframe width="0" height="0" id="'+g+'" name="'+g+'"></iframe>'),d("body").append('<form enctype="multipart/form-data" target="'+g+'" id="'+h+'" action="" method="post"><input style="visibility: hidden;" type="file" '+e+' name="file" id="'+j+'" /></form>');var k=function(a){d("#"+h).remove(),d("#"+g).remove(),s(b,a)};d("#"+j).change(function(b){var e=d(b.currentTarget).val();if(e){var f=e.replace("/","\\").split("\\");return f=f[f.length-1],"function"==typeof c&&c(Y({fileName:f}))===!1?void k(X(3002)):void jb(!0,function(b){b.result?(d("#"+h).attr("action",hb()+"/upload?temppass="+b.password+q(a)),ib(b.password,function(a){var b=/uploadfilesresult count="1"[\s\S]+?path="([\s\S]+?)"/,c=b.exec(a);return c&&c[1]?(c=c[1].replace(/\\/g,"/"),void k(Y({path:c}))):!1}),d("#"+h).submit()):k(X(3001))})}}),d("#"+j).click()},nb=function(a,b){var c=Math.random().toString().replace(".",""),d="_oktelljs_user_avatar_frame_"+c,e="_oktelljs_user_avatar_form_"+c,f="_oktelljs_user_profile_select_file_"+c,g=a.accept;delete a.accept,g?(i(g)||(g=[g]),g='accept="'+g.join(",")+'"'):g="";var h=document.createElement("iframe");h.id=d,h.name=d,h.width=0,h.height=0,document.body.appendChild(h);var j=document.createElement("form");j.id=e,j.style.display="none",j.target=d,j.enctype="multipart/form-data",j.action="",j.method="post",document.body.appendChild(j);var k=document.createElement("input");k.style.visibility="hidden",k.type="file",k.id=f,k.name="file",k.accept=g,j.appendChild(k);var l=function(a){var c;(c=document.getElementById(d)).parentNode.removeChild(c),(c=document.getElementById(e)).parentNode.removeChild(c),s(b,a)};k.onchange=function(){var b=k.value;if(b){var c=b.replace("\\","/").split("/");return c=c[c.length-1],"function"==typeof beforeRequest&&beforeRequest(Y({fileName:c}))===!1?void l(X(3002)):void jb(!0,function(b){b.result?(j.action=hb()+"/upload?temppass="+b.password+"&"+q(a),ib(b.password,function(a){var b=/uploadfilesresult count="1"[\s\S]+?path="([\s\S]+?)"/,c=b.exec(a);return c&&c[1]?(c=c[1].replace(/\\/g,"/"),void l(Y({path:c}))):!1}),j.submit()):l(X(3001))})}},k.click()};N("uploadFile",mb);var ob=function(){function a(a,b){var c=this;c.oktell=a,c.server=b,c.currentMethods={},c.methodTimers={},c.onExecuteMethod=function(b){return b.executionid?(c.currentMethods[b.executionid]=!0,void a.trigger("")):!1},c.onCancelMethod=function(a){return a.executionid?void delete c.currentMethods[a.executionid]:!1},c.onExecuteMethodWaitAborted=function(a){return a.executionid?(c.currentMethods[a.executionid]=!0,void(c.methodTimers[a.executionid]=setTimeout(function(){delete c.currentMethods[a.executionid]},a.waitresponsems))):!1}}return a.prototype.init=function(){var a=this;a.server.bindOktellEvent("dynamic",function(){}),a.server.bindOktellEvent("dynamicwaitabort",function(){}),a.server.bindOktellEvent("executemethod",a.onExecuteMethod,a),a.server.bindOktellEvent("cancelmethod",a.onCancelMethod,a),a.server.bindOktellEvent("executemethodwaitaborted",a.onExecuteMethodWaitAborted,a)},a.prototype.sendMethodResult=function(a,b){var c=this;return c.currentMethods[a]?(delete c.currentMethods[a],void bb("methodresult",{executionid:a,outputparameters:b||{}})):!1},a.prototype.reset=function(){var a=this;a.currentMethods={};for(var b in a.methodTimers)a.methodTimers.hasOwnProperty(b)&&clearTimeout(a.methodTimers[b]);a.server.unbindOktellEvent("executemethod",a.onExecuteMethod),a.server.unbindOktellEvent("cancelmethod",a.onCancelMethod),a.server.unbindOktellEvent("executemethodwaitaborted",a.onExecuteMethodWaitAborted)},a}();h(ob.prototype,w);var pb=(new ob,h({},w,{_stateId:0,states:{DISCONNECTED:0,READY:1,BREAK:2,OFF:3,BUSY:5,RESERVED:6,NOPHONE:7},webStates:{READY:1,DND:2,REDIRECT:3,BREAK:4},onCallCenter:0,_onRedirect:!1,_status:0,_webStateId:0,onBreak:0,breakReasons:{},loadBreakReasons:function(a){var b=this;bb("cc_getlunchtypes",{},function(c){c.result&&m(c.items,function(a){b.breakReasons[a.id.toString()]=a}),s(a,Z(c.result,c,1103," cc_getlunchtypes"))})},getStateStr:function(a){return R(void 0===a?this._stateId:parseInt(a),this.states)},getWebStateStr:function(a){return R(void 0===a?this._webStateId:parseInt(a),this.webStates)},state:function(a){return a=parseInt(a),this.getStateStr(a)&&this._stateId!==a&&(c("SET USER STATE "+a+" "+this.getStateStr(a)),this._stateId=a,this.trigger("userStateChange",this._stateId)),this._stateId},changeStates:function(a,b,c){if(a=this.webStates[a.toString().toUpperCase()]||parseInt(a),!this.getWebStateStr(a))return!1;if(a==this._webStateId&&!this.setAfterBusy||!Q())return!1;var d=this.state();switch(a){case 1:d==this.states.BUSY?this.setAfterBusy=this.webStates.READY:bb("setuserstate",{userstateid:1});break;case 2:d==this.states.BUSY?this.setAfterBusy=this.webStates.DND:(d==this.states.READY||d==this.states.BREAK||d==this.states.OFF)&&bb("setuserstate",{userstateid:3});break;case 3:if(!this.getRedirectNumber())return!1;this.enableUserRedirectState(!0);break;case 4:if(this.onCallCenter){var e={userstateid:2};c&&(this.breakReasons[c]?e.lunchreasonid=c:e.lunchreasonmsg=c),bb("setuserstate",e)}}return this.webState(a,b),!0},webState:function(a,b){if(void 0!==a&&this.getWebStateStr(a)&&this._webStateId!=a){c("SET WEB STATE "+this.getWebStateStr(a));var d=this.getWebStateStr(this._webStateId);this._webStateId=a,b||A.trigger("statusChange",this.getWebStateStr(this._webStateId),d)}return this._webStateId},onRedirect:function(a){return void 0!==a&&(a=a?!0:!1,this._onRedirect!==a&&(this._onRedirect=a,P.trigger("userOnRedirectChanged",this._onRedirect))),this._onRedirect},loadState:function(a){var b=this;bb("getuserstate",{},function(c){c.result&&b.saveStatesFromServer(c),s(a,Z(c.result,c,1103," getuserstate"))})},callCenterState:function(a){return void 0!==a&&(a=a?!0:!1,this.onCallCenter!==a&&(this.onCallCenter=a,A.trigger("callCenterStateChange",this.onCallCenter))),this.onCallCenter},saveStatesFromServer:function(a){this.callCenterState(a.oncallcenter),this.onBreak=a.onlunch,this.onRedirect(a.onredirect);var b=this.webState(),c=this.state();return this.state(a.userstateid),b==this.webStates.DND&&this.setAfterBusy==this.webStates.DND&&5==c&&1==a.userstateid?(this.setAfterBusy=!1,void this.changeStates(this.webStates.DND,!0)):void this.setWebStateFromUserState()},setUserStateBusy:function(){this.state(5)},getUserRedirectId:function(){return d(F.userid.toLocaleLowerCase()+F.userid.toLocaleLowerCase()).toLowerCase()},getRedirectNumber:function(){return F.redirectNumber?F.redirectNumber:void 0},setRedirectNumber:function(a){return F.redirectNumber=a?a:void 0,F.redirectNumber},checkUserRedirect:function(a){var b=this;bb("getredirectrules",{},function(c){if(c.result){c.redirectrules&&c.redirectrules.length>0&&m(c.redirectrules,function(a){a.id.replace(/-/g,"").toLowerCase()==b.getUserRedirectId()&&b.setRedirectNumber(a.destinationnumber)})}s(a,Z(c.result,c,1103," getredirectrules"))})},saveUserRedirect:function(a,b){var c=this;return a?bb("saveredirectrules",{redirectrule:{id:c.getUserRedirectId(),caption:"Переадресация сохраненная из веб-октела. Действует постоянно.",description:"Переадресация сохраненная из веб-октела. Действует постоянно.",priority:1,userid:F.userid,isenabled:!0,allowcascade:!0,state:2,destinationnumber:a,onlyforredirectstate:!0,definesources:!1}},function(d){d.result&&c.setRedirectNumber(a),s(b,Z(d.result,d,1103," saveredirectrules"))}):bb("deleteredirectrules",{ids:[this.getUserRedirectId()]},function(a){a.result&&(c.setRedirectNumber(void 0),c.webState()==c.webStates.REDIRECT&&c.changeStates(c.webStates.READY)),s(b,Z(a.result,a,1103," deleteredirectrules"))}),!0},enableUserRedirectState:function(a){bb("setuserstate",{onredirect:a?!0:!1})},setWebStateFromUserState:function(){if(this.onRedirect())this.webState(this.webStates.REDIRECT);else switch(this.state()){case 1:this.webState(this.webStates.READY);
break;case 2:this.webState(this.webStates.BREAK);break;case 3:this.webState(this.webStates.DND);break;case 5:this.webState(this.onBreak&&this.onCallCenter?this.webStates.BREAK:this.webStates.READY);break;case 7:this.webState(this.webStates.READY)}}}));N("setRedirectNumber",pb.saveUserRedirect,pb),N("getStatus",pb.getWebStateStr,pb),N("setStatus",pb.changeStates,pb),N("setUserStateBusy",pb.setUserStateBusy,pb);var qb={_conferenceInfo:{},_oktellDatedWithConfNumber:140929,_holdNumber:!1,_conferenceId:!1,abonentList:{},queueList:{},answerCheckTimeout:3e3,_talkLength:0,_talkTimer:!1,sip:!1,sipActive:!1,sipHasRTCSession:!1,_notRoutingIvrState:!1,currentSessionData:{},intercomSupport:null,states:{DISCONNECTED:-1,READY:0,BACKCALL:1,CALL:2,RING:3,BACKRING:4,TALK:5},setSipPhone:function(a){var b=this;b.sip=a,b.sip.on("connect",function(){b.sipActive=!0}),b.sip.on("disconnect",function(){b.sipHasRTCSession=!1,b.sipActive=!1}),b.sip.on("ringStart",function(a,b){A.trigger("webrtcRingStart",a,b)}),b.sip.on("RTCSessionFailed",function(){}),b.sip.on("RTCSessionStarted",function(){b.sipHasRTCSession=!0,A.trigger("")}),b.sip.on("RTCSessionEnded",function(){b.sipHasRTCSession=!1,b.loadStates()}),b.sip.on("RTCSessionFailed",function(){b.sipHasRTCSession=!1}),b.sip.on("sessionClose",function(){b.sipHasRTCSession=!1,b.loadStates()})},notRoutingIvrState:function(a){return"undefined"!=typeof a&&Boolean(a)!==this._notRoutingIvrState&&(this._notRoutingIvrState=Boolean(a)),this._notRoutingIvrState},answer:function(a){var b,c,d,e=this;e.sipActive?(e.sip.answer(),s(a,Y())):e.intercomSupport===!1?s(a,X(2902)):e.state()==e.states.RING||e.state()==e.states.BACKRING?(bb("pbxanswercall"),d=function(){clearInterval(b),clearTimeout(checkTimer),s(a,Z(e.intercomSupport,{},2902))},c=function(){return e.intercomSupport=e.state()==e.states.TALK||e.state()==e.states.CALL},b=setInterval(function(){c()&&d()},50),checkTimer=setTimeout(function(){d()},e.answerCheckTimeout)):s(a,X(2901))},setConferenceInfo:function(a){this._conferenceInfo="object"==typeof a?a:{}},getConferenceInfo:function(){return this._conferenceInfo||{}},clearHold:function(){return this.setHold(!1),!0},setHold:function(a){var b=this.getHoldInfo();if(void 0!==a&&(a.userid&&a.userid!=this._holdNumber||a.number&&a.number!=this._holdNumber||a.conferenceid&&a.conferenceid!=this._holdNumber)){var c=this._holdAbonent;this._holdNumber=a.conferenceid?a.conferenceid:a.userid?a.userid:a.number,this._holdAbonent=a.conferenceid?{isConference:!0,conferenceId:a.conferenceid,conferenceName:a.conferencename,conferenceRoom:a.conferenceroom}:this.createAbonent(a);var d=!1;(c&&c.key!=this._holdAbonent.key||!this._holdAbonent)&&(d=!0,A.trigger("holdAbonentLeave",j(c))),c&&this._holdAbonent&&this._holdAbonent.key&&c.key&&this._holdAbonent.key==c.key||(d=!0,A.trigger("holdAbonentEnter",j(this._holdAbonent)));var e=this.getHoldInfo();return(b.hasHold!=e.hasHold||d)&&A.trigger("holdStateChange",j(e)),!0}if(a===!1){this._holdAbonent&&A.trigger("holdAbonentLeave",j(this._holdAbonent)),this._holdAbonent=void 0;var f=this._holdNumber;this._holdNumber=!1,f!==this._holdNumber&&A.trigger("holdStateChange",j(this.getHoldInfo()))}return!1},getHoldInfo:function(){var a={hasHold:this._holdNumber?!0:!1};return a.hasHold&&(this._holdAbonent&&this._holdAbonent.isConference?h(a,j(this._holdAbonent)):(a.isConference=!1,a.abonent=j(this._holdAbonent))),a},conferenceId:function(a,b){if(void 0!==a&&a!=this._conferenceId){var c=this._conferenceId;this._conferenceId=a,c&&bb("confhandleevent",{conferenceid:c,eventtype:"competitors",handle:!1}),this._conferenceId?(bb("confhandleevent",{conferenceid:this._conferenceId,eventtype:"competitors",handle:!0}),b||this.loadConferenceInfo()):this.setConferenceInfo(!1)}return this._conferenceId},isConfCreator:function(a){return void 0!==a&&(this._isConfCreator=a?!0:!1),this._isConfCreator},getStateStr:function(a){return R(void 0===a?this._stateId:parseInt(a),this.states)},apiGetStateStr:function(a){var b=void 0===a?this.state():parseInt(a);return b==this.states.BACKCALL&&(b=this.states.CALL),this.getStateStr(b)},state:function(a,b,d){if(a=parseInt(a),this.getStateStr(a)&&(d||a!=this._stateId)){var e=this.apiGetStateStr(a),f=this._stateId,g=this.apiGetStateStr(f);c("CHANGE STATE FROM "+this.getStateStr(this._stateId)+" TO "+this.getStateStr(a),this.getAbonents(!0),b),this._stateId=a,(a===this.states.READY||a===this.states.DISCONNECTED)&&(this.removeAbonents(),this.conferenceId(!1),this.isConfCreator(!1),a===this.states.DISCONNECTED&&this.clearHold()),A.trigger("stateChange",e,g);var h=this.getAbonents(!0);switch(0==h.length&&(h=b),f){case this.states.READY:A.trigger("readyStop",b);break;case this.states.RING:A.trigger("ringStop",b);break;case this.states.BACKRING:A.trigger("backRingStop",b);break;case this.states.CALL:A.trigger("callStop",b);break;case this.states.BACKCALL:A.trigger("callStop",b);break;case this.states.TALK:A.trigger("talkStop",b)}switch(this._stateId){case this.states.READY:A.trigger("readyStart",h);break;case this.states.RING:A.trigger("ringStart",h);break;case this.states.BACKRING:A.trigger("backRingStart",h);break;case this.states.CALL:A.trigger("callStart",h);break;case this.states.BACKCALL:A.trigger("callStart",h);break;case this.states.TALK:A.trigger("talkStart",h)}}return this._stateId},loadFlashInfo:function(a){var b=this;bb("getflashedabonentinfo",{},function(c){c.result&&(c.containsflashed&&c.abonent?b.setHold(c.abonent):b.clearHold()),s(a,Z(c.result,c,1103," getflashedabonentinfo"))})},loadStates:function(a,b){var d=this;return b=b||{},h(d.currentSessionData,b),Q()?void bb("getextendedlineinfo",{},function(b){var e=function(){s(a,Z(b.result,b,1103," getextendedlineinfo"))};if(c("getextendedlineinfo result and that.currentSessionData",b,d.currentSessionData),b.result){var f=d.state(),g=(d.getHoldInfo(),d.getAbonents(!0)),h=(g&&g[0]||!1,function(){c("setStateFromResultData");{var a=(d.getHoldInfo(),d.getAbonents(!0));a&&a[0]||!1}if(d.currentSessionData.isAutoCall&&!b.abonent.isautocall&&f==d.states.READY)d.state(d.states.BACKRING,g);else if(b.abonent.isautocall)d.currentSessionData.isAutoCall=!1,d.state(d.states.BACKCALL,g);else if(b.abonent.isringing)"acm_callback"==b.abonent.direction||f==d.states.BACKRING?d.state(d.states.BACKRING,g):d.state(d.states.RING,g);else if(!d.currentSessionData.isAutoCall&&(b.abonent.iscommutated||b.abonent.iswaitinginflash||b.abonent.isconference)||"lsCommutated"==b.linestatestr&&b.abonent.isivr&&!b.abonent.isroutingivr){d.startTalkTimer(parseInt(b.timertalklensec)||0);var e=d.currentSessionData.commStopped;d.currentSessionData.commStopped=!1,d.state(d.states.TALK,g,e)}else b.abonent.extline||b.abonent.number?(d.currentSessionData.isAutoCall=!1,d.state(d.states.CALL,g)):"lsDisconnected"==b.linestatestr?d.state(d.states.DISCONNECTED):f==d.states.TALK&&d.sipHasRTCSession||"lsReserved"!=b.linestatestr&&(d.currentSessionData={},d.state(d.states.READY,g))});d.setHold(b.isflashing&&b.flashed?b.flashed:!1),b.abonent?b.abonent.conferenceid?(d.conferenceId(b.abonent.conferenceid,!0),d.loadConferenceInfo(function(){h(),e()})):(b.abonent.chainId=b.chainid,d.setAbonent(b.abonent,f==d.states.TALK&&d.sipHasRTCSession||b.abonent.isivr||d.currentSessionData.isAutoCall),d.conferenceId(!1),h(),e()):e()}else e()}):!1},loadConferenceInfo:function(a){var b=this;bb("getconferenceinfo",{conferenceid:this.conferenceId()},function(c){b.setConfAbonentList(c.competitors),b.setConferenceInfo(c.conference),s(a,Z(c.result,c,1103," getconferencecompetitors"))})},createAbonent:function(a){var b=a.competitorid||a.number||a.userid||a.callerid||"00000000-0000-0000-0000-000000000000"!=a.chainId&&a.chainId;if(!b&&a.isivr&&(b=p()),b){var c=new y;return h(c,{key:b,guid:a.competitorid||a.userid,isIvr:a.isivr,ivrName:a.ivrname||void 0,isConferenceCompetitor:a.competitorid?!0:!1,conferenceId:this.conferenceId(),isConferenceCreator:a.competitorid&&a.iscreator?!0:void 0,isConferenceDirector:a.competitorid&&a.isdirector?!0:void 0,isConferenceGhost:a.competitorid&&a.isghost?!0:void 0,isConferenceGhostMajor:a.competitorid&&a.isghostmajor?!0:void 0,isConferenceHidden:a.competitorid&&a.ishidden?!0:void 0,isExternal:a.isextline?!0:!1,chainId:a.chainId,phone:a.number?a.number.toString():a.calledid?a.callerid.toString():void 0,phoneFormatted:a.number?o(a.number.toString()):void 0,name:a.simplename||a.username||a.name||a.caption||a.userlogin||a.number||a.ivrname,isUser:a.userid?!0:!1,user:{id:a.userid||void 0,name:a.username||void 0,login:a.userlogin||void 0,comment:a.comment||void 0},isClient:void 0,client:{id:void 0,name:void 0},line:{id:void 0,number:void 0}}),c}return!1},setAbonent:function(a,b){var c;k(this.abonentList)&&m(this.abonentList,function(a,b){c=b});var d=this.abonentList[c];this.abonentList={};var e=a?this.createAbonent(a):void 0;return e?(this.abonentList[e.key]=e,e.key!=c&&(A.trigger("abonentListChange",this.getAbonents()),A.trigger("abonentsChange",this.getAbonents(!0)))):d&&b?this.abonentList[c]=d:c&&(A.trigger("abonentListChange",this.getAbonents()),A.trigger("abonentsChange",this.getAbonents(!0))),this.abonentList},setConfAbonentList:function(a){var b={},c=this;a&&i(a)&&m(a,function(a){if((!c.getConferenceInfo().isghost||c.getConferenceInfo().isghost&&(a.isghost||a.userid==F.userid||a.number==F.number))&&(b[a.competitorid]=!0,!c.abonentList[a.competitorid])){var d=c.createAbonent(a);c.abonentList[d.key]=d,c.conferenceId()&&c.state()==c.states.TALK&&A.trigger("conferenceAbonentEnter",c.abonentList[d.key])}});var d=c.getAbonents();return m(d,function(a,d){b[d]||c.removeAbonents(d)}),A.trigger("abonentListChange",c.getAbonents()),A.trigger("abonentsChange",c.getAbonents(!0)),!0},getAbonents:function(a){var b=a?[]:{};return m(this.abonentList,function(c,d){a?b.push(j(c)):b[d]=j(c)}),b},isAbonent:function(a,b){if(!a)return!1;if(b=b||this.getAbonents(),k(b)){b.key&&(b=[b]);var c=!1;return m(b,function(b){return b.guid&&b.guid==a||b.user&&b.user.id&&b.user.id==a||b.client&&b.client.id&&b.client.id==a||b.phone&&b.phone==a?(c=j(b),l):void 0}),c}return!1},removeConfAbonents:function(){var a=this;m(a.abonentList,function(b,c){a.conferenceId()&&a.state()==a.states.TALK&&b.isConferenceCompetitor&&A.trigger("conferenceAbonentLeave",b),delete a.abonentList[c]})},removeAbonents:function(a){var b=this;if(a&&b.abonentList[a])b.conferenceId()&&b.state()==b.states.TALK&&b.abonentList[a].isConferenceCompetitor&&A.trigger("conferenceAbonentLeave",b.abonentList[a]),delete b.abonentList[a],A.trigger("abonentListChange",b.getAbonents()),A.trigger("abonentsChange",b.getAbonents(!0));else{if(void 0!==a||!k(b.abonentList))return!1;m(b.abonentList,function(a,c){b.conferenceId()&&b.state()==b.states.TALK&&a.isConferenceCompetitor&&A.trigger("conferenceAbonentLeave",a),delete b.abonentList[c]}),b.abonentList={}}return A.trigger("abonentListChange",b.getAbonents()),A.trigger("abonentsChange",b.getAbonents(!0)),!0},makeCall:function(a,b,d,e){var f,g=this,h="";if(a||(f=2106),pb.state()==pb.states.DISCONNECTED&&(f=2001),g.state()==g.states.DISCONNECTED&&(f=2002),g.getHoldInfo().hasHold&&g.state()==g.states.TALK&&(f=2101),g.conferenceId()&&(f=2102),-1!=[g.states.BACKCALL,g.states.BACKRING,g.states.CALL,g.states.RING].indexOf(g.state())&&(f=2103,h=" ("+g.getStateStr()+")"),g.state()!=g.states.READY||pb.state()!=pb.states.BUSY||g.getHoldInfo().hasHold||(f=2104),f)return s(e,X(f)),!1;if(g.isAbonent(a))return s(e,X(2105)),!1;if(g.state()==g.states.READY&&g.sipActive&&!b){g.state()==g.states.TALK&&g.sip.hold(),g.sip.call(a);{J[a],K[a]||L[a]}s(e,Y())}else{if(g.state()!=g.states.READY&&g.state()!=g.states.TALK)return c("error call, unknown state"),s(e,X(2108)),!1;g.acmCall(a,b,d,function(a){s(e,Z(a.result,a,2107))})}},acmCall:function(a,b,c,d){if(c=-1!==["abonent","user"].indexOf(c)?c:"user",!a)return!1;var e={sequence:b?"user":c,intercom:b?!0:void 0};e.number=a.toString(),bb("pbxautocallstart",e,function(a){s(d,a)})},toggleHold:function(a){var b=this;b.getHoldInfo().hasHold?(b.makeFlash("switch"),s(a,Y())):s(a,X(2402))},makeFlash:function(a){var b=["abort","switch","next"];bb("pbxmakeflash",{mode:-1!=b.indexOf(a)?a:void 0})},conference:function(a,b){var c=this;a=S(a),pb.state()==pb.states.BREAK?s(b,X(2208)):c.state()==c.states.TALK?c.conferenceId()&&a?c.inviteToConf(c.conferenceId(),a,b):c.conferenceId()||c.callToConf(a?function(d){d.result?c.inviteToConf(c.conferenceId(),a,b):s(b,X(2202))}:b):c.state()==c.states.READY&&!c.conferenceId()&&a?c.createConf(a,b):s(b,X(2205))},callToConf:function(a){var b=this;b.buildConfFromCommCallback=a,b.buildConfFromCommTimer=setTimeout(function(){s(b.buildConfFromCommCallback,X(2202)),b.buildConfFromCommCallback=void 0},2e3),bb("buildconferencefromcommutation")},createConf:function(a,b){var c=this,d=p(),e=Math.round(1e4*Math.random()),f=[{userlogin:F.login}];a=S(a),i(a)&&m(a,function(a){f.push(r(a)?{userid:a}:F.oktellDated>=c._oktellDatedWithConfNumber?{number:a}:{intnumber:a})}),k(f)>1?bb("createnewconference",{conference:{id:d,room:e,name:"",description:"",accessmode:"free",isselector:!1,record:!0,recordrights:"selected",everyonecaninvite:!0,canvieweachother:!0},competitors:f},function(a){1==a.result?c.conferenceId(d,!0):c.conferenceId(!1),s(b,Z(a.result,a,2204))}):s(b,X(2203))},inviteToConf:function(a,b,c){a||s(c,!1);var d=this;b=S(b);var e,f=[],g=d.getHoldInfo().abonent||{};i(b)&&m(b,function(a){"string"==typeof a&&""!==a&&(d.isAbonent(a,g)?e=a:f.push(r(a)?{userid:a}:{number:a}))});var h=function(){bb("invitetoconference",{conferenceid:a,competitors:f},function(a){s(c,Z(a.result,a,2202))})};if(0!=k(f)||e)if(e){if(a!=d.conferenceId())return void s(c,X(2206));bb("checkcanconnecttogathertoconference",{},function(a){a.canconnecttogather?(bb("connecttogathertoconference"),0!=k(f)?h():s(c,Y())):s(c,X(2206))})}else 0!=k(f)?h():s(c,X(2207));else s(c,X(2201))},endCall:function(a){var b=this;a=S(a);var c=!1,d=!1;a&&m(a,function(a){!c&&b.isAbonent(a)&&(c=!0),d||a!=F.number&&a!=F.userid||(d=!0)}),a?b.getHoldInfo().hasHold&&(d||!b.conferenceId()&&c)?b.makeFlash("abort"):(c||d)&&(b.state()==b.states.TALK?b.conferenceId()?b.kickConfAbonent(b.conferenceId(),a):b.abortCall():b.state()==b.states.BACKCALL?b.abortAcmCall():b.state()==b.states.CALL?b.abortCall():(b.state()==b.states.RING||b.state()==b.states.BACKRING)&&b.declineCall()):b.state()==b.states.TALK||b.state()==b.states.CALL||b.getHoldInfo().hasHold?b.abortCall():b.state()==b.states.BACKCALL?b.abortAcmCall():(b.state()==b.states.RING||b.state()==b.states.BACKRING)&&b.declineCall()},abortCall:function(){bb("pbxabortcall")},declineCall:function(){bb("pbxdeclinecall")},kickConfAbonent:function(a,b){b=S(b);var c=this;bb("getconferencecompetitors",{conferenceid:a},function(d){for(var e={},f={},g=!1,h=0,i=d.competitorlist.length;i>h;h++)e[d.competitorlist[h].number]=d.competitorlist[h].competitorid,f[d.competitorlist[h].userid]=d.competitorlist[h].competitorid;var j;m(b,function(b){(j=e[b]||f[b]||"")&&(!b||b!=F.number&&b!=F.userid?bb("confdisconnectcompetitor",{conferenceid:a,competitor:{competitorid:j}}):g=!0)}),g&&c.exitConf(a)})},abortAcmCall:function(){bb("pbxautocallabort")},exitConf:function(a){bb("exitconference",{conferenceid:a})},makeTransfer:function(a,b){bb("pbxmaketransfer",{transferto:a?a+"":""}),s(b,Y())},transfer:function(a,b){var c=this;a||s(b,X(2304)),c.state()==c.states.TALK?c.getHoldInfo().hasHold?!a||c.isAbonent(a,c.getHoldInfo().abonent||{})?(c.endCall(void 0),s(b,Y())):c.makeTransfer(a,b):a?c.makeTransfer(a,b):s(b,X(2302)):s(b,X(2303))},ghost:function(a,b,c){var d=this,e=function(a){d.loadConferenceInfo(s(c,a))};if(a=J[a]&&J[a].id||K[a]&&K[a].userid,!a)return s(e,X(2504)),!1;if(b=b||"monitor",-1==["monitor","conference","help"].indexOf(b))return s(e,X(2503)),!1;if(d.state()==d.states.READY)bb("attachasghost",{ghostedid:a},function(a){a.result?b&&"monitor"!=b?setTimeout(function(){d.conferenceId()&&d.changeGhostMode(b,e)},500):s(e,Y()):52710==a.error?s(e,X(2505)):s(e,X(2502))});else{var f=d.isAbonent(F.userid),g=d.conferenceId();if(!f||!g||!d.getConferenceInfo().isghost)return s(e,X(2506)),!1;var h=d.isAbonent(a);if(!h)return s(e,X(2507)),!1;h.isConferenceGhostMajor||"help"!=b&&"monitor"!=b?bb("confsetghostmode",{conferenceid:g,ghostmode:b},function(a){a.result,s(e,Z(a.result,{},2502))}):bb("confsetvoiceparams",{conferenceid:g,competitor:{competitorid:h.guid,ghosthelp:"help"==b?!0:!1}},function(a){a.result,s(e,Z(a.result,{},2502))})}},queue:function(a){var b=this;bb("getcurrentqueue",{},function(c){if(c.result){var d={},e=[],f=!1;i(c.queue)&&k(c.queue)>0&&m(c.queue,function(a){ab=b.createAbonent(a),d[ab.key]=ab,e.push(ab),b.queueList[ab.key]||b.isAbonent(ab.key)||(b.queueList[ab.key]=ab,A.trigger("queueAbonentEnter",ab),f=!0)}),m(b.queueList,function(a,c){d[c]||(A.trigger("queueAbonentLeave",a),delete b.queueList[c],f=!0)}),f&&A.trigger("queueChange",e),s(a,Y({queue:e}))}else s(a,X(2701))})},startTalkTimer:function(a){var b=this;b.clearTalkTimer(!0),b._talkLength=Date.now()-1e3*(parseInt(a)||0),b.triggerTalkTimeEvent(),b._talkTimer=setInterval(function(){b.triggerTalkTimeEvent()},1e3)},triggerTalkTimeEvent:function(){var a=this;if(a._talkLength!==!1){var b=a.getCurrentTalkLength();A.trigger("talkTimer",b,a.formatTime(b))}else A.trigger("talkTimer",!1)},getCurrentTalkLength:function(){return Math.floor((Date.now()-this._talkLength)/1e3)},clearTalkTimer:function(a){clearInterval(this._talkTimer),this._talkLength=!1,a||this.triggerTalkTimeEvent()},formatTime:function(a){var b=a,c=Math.floor(b/3600),d=Math.floor(b/60)%60,e=b%60;return(c?c+":":"")+(10>d?"0"+d:d)+":"+(10>e?"0"+e:e)},talkLength:function(a){if(this._talkLength===!1)return"";var b=this.getCurrentTalkLength();return a?this.formatTime(b):b},dtmf:function(a){return this.sipActive&&"string"==typeof a&&a.match(/^[0-9\*#]{1}$/)?this.sip.dtmf(a):!1},hold:function(){this.sipActive?this.sip.hold():(this.state()==this.states.TALK||this.getHoldInfo().hasHold)&&this.makeFlash("switch")},resume:function(){this.getHoldInfo().hasHold&&this.sipActive&&this.sip.resume()}};h(qb,w),N("isAbonent",qb.isAbonent,qb),N("conferenceId",qb.conferenceId,qb),N("getHoldInfo",qb.getHoldInfo,qb),N("endCall",qb.endCall,qb),N("conference",qb.conference,qb),N("transfer",qb.transfer,qb),N("toggle",qb.toggleHold,qb),N("getState",qb.apiGetStateStr,qb),N("getQueue",qb.queue,qb),N("getTalkLength",qb.talkLength,qb),N("answer",qb.answer,qb),N("dtmf",qb.dtmf,qb),N("hold",qb.hold,qb),N("resume",qb.resume,qb);var rb={};rb["-"]={},rb[qb.states.DISCONNECTED]={},rb[qb.states.BACKCALL]={endCall:1},rb[qb.states.BACKRING]={endCall:1,answer:1},rb[qb.states.CALL]={endCall:1,conference:1,call:1,intercom:1,transfer:1},rb[qb.states.READY]={conference:1,call:1,intercom:1,ghostListen:1,ghostHelp:1,ghostConference:1,transfer:1,toggle:1,endCall:1,resume:1},rb[qb.states.RING]={endCall:1,answer:1},rb[qb.states.TALK]={endCall:1,conference:1,call:1,resume:1,hold:1,intercom:1,toggle:1,transfer:1,ghostListen:1,ghostHelp:1,ghostConference:1};var sb={};sb["-"]={},sb[pb.states.DISCONNECTED]={},sb[pb.states.READY]={endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,ghostListen:1,ghostHelp:1,ghostConference:1,resume:1},sb[pb.states.BREAK]={endCall:1,call:1,intercom:1,toggle:1,transfer:1,ghostListen:1,resume:1,ghostHelp:1,ghostConference:1},sb[pb.states.OFF]={endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,ghostListen:1,ghostHelp:1,ghostConference:1},sb[pb.states.BUSY]={answer:1,endCall:1,conference:1,call:1,intercom:1,toggle:1,transfer:1,resume:1,hold:1,ghostListen:1,ghostHelp:1,ghostConference:1},sb[pb.states.RESERVED]={},sb[pb.states.NOPHONE]={};var tb=function(){var a=[],b=qb.state();b="number"==typeof b?b:"-";var c=pb.state()||"-";c="number"==typeof c?c:"-",this.push=function(){m(arguments,function(d){rb[b][d]&&sb[c][d]&&a.push(d)})},this.getActions=function(){return a}},ub=function(a){var b=new tb;if(!a||!Q())return b.getActions();J[a]&&J[a].number&&!K[a]&&!L[a]&&(a=J[a].number);var c=F.userid==a||F.number==a,d=qb.isAbonent(a,qb.getHoldInfo().abonent||{}),e=J[a]||K[a]||L[a];e&&e.numberObj&&(e=e.numberObj);var f=qb.isAbonent(a)||e&&e.number&&qb.isAbonent(e.number),g=qb.isAbonent(a,qb.queueList)||e&&e.number&&qb.isAbonent(e.number,qb.queueList),h=qb.getHoldInfo().hasHold,i=qb.conferenceId()?!0:!1,j=(i&&f&&f.isConferenceCreator,i&&qb.isAbonent(F.userid)),k=i&&j&&j.isConferenceCreator,l=qb.state(),m=qb.intercomSupport;return g||(c?l!=qb.states.DISCONNECTED&&l!=qb.states.READY&&(l!=qb.states.RING&&l!=qb.states.BACKRING||!qb.sipActive&&m===!1||b.push("answer"),b.push("endCall")):(!e||e&&void 0!==e.state&&0!=e.state)&&(d?qb.sipActive&&qb.sip&&"function"==typeof qb.sip.isOnHold&&qb.sip.isOnHold()?b.push("resume"):b.push("toggle","endCall"):f?f&&(l!=qb.states.RING&&l!=qb.states.BACKRING||!qb.sipActive&&m===!1||b.push("answer"),i?k&&b.push("endCall"):(b.push("endCall"),qb.sipActive&&!h&&b.push("hold"),e&&2==e.state||b.push("conference")),qb.getConferenceInfo().isghost&&fb(a)&&b.push("ghostListen","ghostHelp","ghostConference")):(i?(e&&2==e.state||b.push("conference"),b.push("transfer")):!h&&l==qb.states.TALK||l==qb.states.READY?(b.push("call"),l==qb.states.TALK&&b.push("transfer"),e&&2==e.state||b.push("conference"),b.push("intercom")):h&&l==qb.states.TALK&&b.push("transfer"),e&&5==e.state&&l==qb.states.READY&&fb(a)&&b.push("ghostListen","ghostHelp","ghostConference")))),b.getActions()};N("getPhoneActions",ub),startQueueTimer=function(a){clearInterval(n),n=setInterval(function(){Q()&&qb.queue()},a)};var vb=function(b){if(A.trigger("connecting"),Q())return!0;b=b||{};var j=!1;h(D,b),a=D.debugMode,u=!1,D.oktellVoice&&(D.oktellVoice.isOktellVoice===!0?u=D.oktellVoice:window.oktellVoice&&window.oktellVoice.isOktellVoice===!0&&(u=window.oktellVoice));var k=t(I)||localStorage&&localStorage[I];k||void 0===b.password||null===b.password?(D.password=void 0,D.Password=void 0):(D.password=d(f(b.password.toString().toLowerCase())),D.Password=d(f(b.password.toString())));var l=/^w[s]{1,2}:\/\/\S+$/,m=/:[0-9]{1,5}$/,n=function(a){if(l.test(a))return a;var b="https:"==location.protocol,c=b?":443":":80",d=b?"wss://":"ws://";return m.test(a)?d+a:d+a+c};if("string"==typeof D.url&&(D.url=[D.url]),!i(D.url))return s(D.callback,X(1205)),A.trigger("connectError",X(1205)),!1;for(var o=[],p=0,q=D.url.length;q>p;p++)"string"==typeof D.url[p]&&o.push(n(D.url[p]));D.url=o,F.url=D.url,F.login=D.login,F.defaultAvatar=D.defaultAvatar,F.defaultAvatar32x32=D.defaultAvatar32x32,F.defaultAvatar64x64=D.defaultAvatar64x64;if(!k&&(void 0===D.password||null===D.password))return s(D.callback,X(1213)),A.trigger("connectError",X(1213)),!1;var r=function(){e=new x(D.url,D.openTimeout,D.queryDelayMin,D.queryDelayMax,function(b){j=!1,F.currentUrl=e.url,bb("login",{Password:D.Password,password:D.password,sessionid:k||void 0,showid:1,usewebrtc:u?!0:!1,workplace:D.workplace||void 0,expires:D.expires||void 0},function(d){j=!0;var f=function(){return X(h,"",{serverErrorMessage:d.errormsg,serverErrorCode:d.error})};if(d.error||d.errormsg){var h=1e3;50093==d.error?h=1204:50025==d.error?h=1214:"Service not available"==d.errormsg?h=1215:"Wrong login/pass combination"==d.errormsg?(t(I,null),localStorage&&delete localStorage[I],h=1202):("Bad request. Session does not exist"==d.errormsg||"Bad request. Invalid session user"==d.errormsg)&&(t(I,null),localStorage&&delete localStorage[I],h=1212),s(D.callback,f(h)),A.trigger("connectError",f(h)),wb(14)}else 1==d.result?(clearInterval(g),g=setInterval(function(){Q()&&e.sendOktell("ping")},15e3),startQueueTimer(D.queueInterval),qb.queue(),db.sendCustomBinding(),e.bindOktellEvent("userstatechanged",function(a){pb.saveStatesFromServer(a)}),u&&setTimeout(function(){z=u.connect({login:d.sipuser,password:d.sippass,server:b.replace(/w[s]{1,2}:\/\//,"").replace("/","").split(":")[0]+":"+d.sipport,useWSS:d.sipsecure,debugMode:a}),z&&(z.on("connect",function(){E=!0,A.trigger("webphoneConnect")}),z.on("all",function(a){c("Oktell webphone event: "+a,arguments)}),z.on("disconnect",function(){E=!0,A.trigger("webphoneDisconnect")}),qb.setSipPhone(z))},200),F.userid=d.userid,F.sessionId=d.sessionid,F.sessionId&&(t(I,F.sessionId,{expires:D.expires}),localStorage&&(localStorage[I]=F.sessionId)),bb("getversion",{showalloweddbstoredprocs:1},function(a){a.result?(F.oktellDated=a.version.dated,F.oktellBuild=a.version.build,F.oktellDated<140918&&/2\.11\.[0-9]{4}\.[0-9]{5}/g.test(F.oktellBuild)&&(F.oktellBuild="2.11.1."+F.oktellDated),F.allowedProcedures=a.alloweddbstoredprocs||{},F.oktellWebServerPort=a.version.webserverport,F.oktellWebServerLink=hb(),T("pbxanswercall")||(qb.intercomSupport=!1),bb("getmyuserinfo",{},function(a){a.result?(F.number=a.mainpbxnumber,F.username=a.username,F.hasline=a.hasline,F.lineid=a.lineid,F.linenumber=a.linenumber,F.isoperator=a.isoperator,pb.loadBreakReasons(function(){pb.loadState(function(a){a?pb.checkUserRedirect(function(){gb(function(){e.bindOktellEvent("pbxnumberstatechanged",function(a){for(var b=0;b<a.numbers.length;b++){var c=K[a.numbers[b].num];c&&(c.state=a.numbers[b].numstateid)}}),eb(function(){qb.loadStates(function(a){if(a){j=!1,P.trigger("login"),e.bindOktellEvent("httpresponsecopy",function(a){var b=a.response;if("200 OK"==b){var c=a.password,d=a.content;H[c]&&"function"==typeof H[c].callback&&H[c].callback(d)}}),s(D.callback,Y()),O(!0);for(var b=0;b<C.length;b++){var c=C[b];c&&c.eventName&&c.callback&&!c.binded&&(c.binded=!0,e.bindOktellEvent(c.eventName,c.callback))}A.trigger("connect")}else s(D.callback,f(1207)),A.trigger("connectError",f(1207)),wb(14)})})})}):(s(D.callback,f(1209)),A.trigger("connectError",f(1209)),wb(14))})})):(s(D.callback,f(1210)),A.trigger("connectError",f(1210)),wb(14))})):(s(D.callback,f(1206)),A.trigger("connectError",f(1206)),wb(11))})):(s(D.callback,f(1211)),A.trigger("connectError",f(1211)),wb(14))})}),e.on("errorConnection",function(){A.trigger("connectError",X(1200)),s(D.callback,X(1200))}),e.on("connectionClose",function(){M?(M=!1,wb(13)):j||wb(12)}),e.multiConnect(),a&&(F.server=e)};r()};N("connect",vb);var wb=function(a,b){O(!1);for(var c=0;c<C.length;c++){var d=C[c];d.binded=!1}return z&&z.disconnect&&z.disconnect(),Q()?(t(I,null),localStorage&&delete localStorage[I],M=!0,pb.state(0),qb.state(qb.states.DISCONNECTED),bb("logout")):("number"==typeof a&&(a=V(a)),b||A.trigger("disconnect",a)),!0},xb=function(){return t(I,null),!0};N("removeUserSession",xb),pb.on("userStateChange",function(a){setTimeout(function(){qb.loadStates()},400),5==a||(7==a?qb.state(qb.states.DISCONNECTED):qb.loadStates())}),P.on("login",function(){e.bindOktellEvent("linestatechanged",function(){setTimeout(function(){qb.loadStates()},500)}),e.bindOktellEvent("flashstatechanged",function(){setTimeout(function(){qb.loadStates()},500)}),e.bindOktellEvent("confcompositionchanged",function(a){a.eventinfo.conferenceid==qb.conferenceId()&&(qb.setConfAbonentList(a.eventinfo.competitorlist),qb.loadStates())}),e.bindOktellEvent("phoneevent_acmcallstarted",function(){qb.loadStates(null,{isAutoCall:!0})}),e.bindOktellEvent("phoneevent_acmcallstopped",function(){setTimeout(function(){qb.loadStates()},700)}),e.bindOktellEvent("phoneevent_ringstarted",function(){qb.loadStates(function(){qb.conferenceId()&&qb.loadConferenceInfo()},!1)}),e.bindOktellEvent("phoneevent_ringstopped",function(){qb.loadStates()}),e.bindOktellEvent("phoneevent_ivrstarted",function(a){a.isroutingivr===!1?qb.notRoutingIvrState(!0):a.isroutingivr===!0&&qb.state()==qb.states.READY&&qb.loadStates()}),e.bindOktellEvent("phoneevent_commstarted",function(a){qb.startTalkTimer(0),qb.currentSessionData.commStarted=!0,a.isconference?(qb.buildConfFromCommCallback&&(qb.isConfCreator(!0),clearTimeout(qb.buildConfFromCommTimer)),qb.conferenceId(a.confid),qb.loadConferenceInfo(function(){qb.loadStates(function(){qb.buildConfFromCommCallback&&(s(qb.buildConfFromCommCallback,Y()),qb.buildConfFromCommCallback=void 0)})})):setTimeout(function(){qb.loadStates(function(){})},700)}),e.bindOktellEvent("phoneevent_commstopped",function(){qb.clearTalkTimer(),qb.currentSessionData.commStopped=!0,setTimeout(function(){qb.loadStates(function(){})},700)}),pb.loadBreakReasons()}),A.disconnect=function(a){return wb(13,a)},A.getAbonents=function(){return qb.getAbonents(!0)},A.call=function(a,b,c){qb.makeCall(a,!1,"string"==typeof b?b:"","function"==typeof b?b:c)},A.onNativeEvent=function(a,b){$(a,b)},A.offNativeEvent=function(a,b){_(a,b)},A.getMyInfo=function(){return j(F)},A.intercom=function(a,b){qb.makeCall(a,!0,"",b)},A.ghostListen=function(a,b){qb.ghost(a,"monitor",b)},A.ghostHelp=function(a,b){qb.ghost(a,"help",b)},A.ghostConference=function(a,b){qb.ghost(a,"conference",b)},A.getUsers=function(){var a={};return m(J,function(b){a[b.id]=b}),a},A.getNumbers=function(){var a={};return m(K,function(b){a[b.number]=b}),a},A.getLunchReasons=A.getBreakReasons=function(){return j(pb.breakReasons)||{}},A.getLog=function(){return b},N("formatPhone",o,void 0),A.inCallCenter=function(){return pb.callCenterState()},A.webphoneIsActive=function(){return E},A.changePassword=function(a,b,c){"string"==typeof a&&a?(a=d(f(a)),b=d(f(b)),A.exec("changepassword",{newpwdmd5:a,oldpwdmd5:b},function(a){a.result?s(c,Y({result:!0})):"old password is wrong"==a.errormsg?s(c,X(2801)):s(c,X(2803))})):s(c,X(2802))},A.config=function(b){return b?(void 0!==b.debugMode&&(a=Boolean(b.debugMode)),void 0!==b.queryDelayMin&&(e?e.setQueryDelayMin(b.queryDelayMin):D.queryDelayMin=b.queryDelayMin),void 0!==b.queryDelayMax&&(e?e.setQueryDelayMax(b.queryDelayMax):D.queryDelayMax=b.queryDelayMax),void 0!==b.queueInterval&&parseInt(b.queueInterval)&&startQueueTimer(parseInt(b.queueInterval)),void(void 0!==b.queryTimeout&&parseInt(b.queryTimeout)&&(D.queryTimeout=parseInt(b.queryTimeout)))):!1},A.version="1.7.2"};return h(z.prototype,w),z}(),window.oktell=new Oktell;